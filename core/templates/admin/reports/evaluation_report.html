{% extends "admin/base_site.html" %}
{%load static%}
{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/fonts.css' %}">
<link rel="stylesheet" href="{% static 'css/base.css' %}">
<link rel="stylesheet" href="{% static 'css/evaluation_report.css' %}">
{% endblock %}

{% block content %}
<div class="report-card">
    <h2>Ú¯Ø²Ø§Ø±Ø´ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</h2>
    <p class="muted">Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø­Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ ÙØ±Ø¯ÛŒ Ø³Ù¾Ø³ Ú©Ø§Ø±Ù…Ù†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>

       <div class="filter-group">
           <label for="orgSelect"><strong>Ø³Ø§Ø²Ù…Ø§Ù†:</strong></label>
            <select id="orgSelect" style="width:100%; margin-bottom:12px;" class="form-control">
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                {% for org in organizations %}
                <option value="{{ org.id }}">{{ org.name }}</option>
                {% endfor %}
            </select>
        </div>

    <div class="row">

        <div>
            <label>ÙˆØ§Ø­Ø¯</label>
            <input type="search" id="unitSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ÙˆØ§Ø­Ø¯Ù‡Ø§...">
            <select id="unitSelect" size="8" aria-label="ÙˆØ§Ø­Ø¯" class="unitSelect"></select>
            <small class="muted">Ù„ÛŒØ³Øª ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</small>
        </div>

        <div>
            <div class="toggle" role="tablist" aria-label="Ø­Ø§Ù„Øª Ú¯Ø²Ø§Ø±Ø´">
                <button id="modeIndividual" class="active" data-mode="individual">ÙØ±Ø¯ÛŒ</button>
                <button id="modeUnit" data-mode="unit">ØªØ¬Ù…ÛŒØ¹ÛŒ ÙˆØ§Ø­Ø¯</button>
            </div>

            <div id="employeeBox" style="margin-top:12px">
                <label>Ú©Ø§Ø±Ù…Ù†Ø¯ (Ø¨Ø§ Ø¬Ø³ØªØ¬Ùˆ)</label>
                <input type="search" id="employeeSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† ÙˆØ§Ø­Ø¯...">
                <select id="employeeSelect" size="8" aria-label="Ú©Ø§Ø±Ù…Ù†Ø¯" class="employeeSelect"></select>
                <small class="muted">Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø­Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯.</small>
            </div>
        </div>
    </div>

<div class="filter-row" style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
<div class="filter-col" style="flex: 1;">
    <label for="yearSelect">Year:</label>
    <select id="yearSelect" class="filter-input" style="width:100%; margin-top:4px;">
      <option value="">All</option>
    </select>
  </div>

  <div class="filter-col" style="flex: 1;">
    <label>Ø¯ÙˆØ±Ù‡:</label>
    <div id="periodRadios" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:4px;">
      <label><input type="radio" name="period" value="3"> Û³ Ù…Ø§Ù‡Ù‡</label>
      <label><input type="radio" name="period" value="6"> Û¶ Ù…Ø§Ù‡Ù‡</label>
      <label><input type="radio" name="period" value="9"> Û¹ Ù…Ø§Ù‡Ù‡</label>
      <label><input type="radio" name="period" value="12" checked> Û±Û² Ù…Ø§Ù‡Ù‡</label>
    </div>
  </div>
</div>

    <div class="actions-row">
        <button class="button" id="btnDraw">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</button>
        <button class="button" id="btnCsv">ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ CSV</button>
        <button class="button" id="btnPdf">ğŸ“„ Ø®Ø±ÙˆØ¬ÛŒ PDF</button>
        <button id="btnPrintForm" class="btn btn-outline-secondary">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª ÙØ±Ù…</button>
        <span id="status" class="muted"></span>
    </div>
</div>

<div class="report-row" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; margin-top: 20px;">

  <div class="report-card" style="flex: 1; min-width: 45%; text-align: center;">
      <h3 id="chartTitle">â€”</h3>
      <div style="position: relative;">
          <canvas id="chartCanvas"></canvas>
      </div>
  </div>

  <div class="report-card" style="flex: 1; min-width: 45%; text-align: center;">
      <h3 id="pieTitle">â€”</h3>
      <div style="position: relative; ">
          <canvas id="pieCanvas"></canvas>
      </div>
  </div>

</div>


<div class="report-card">
    <h3>Ø®Ù„Ø§ØµÙ‡</h3>
    <div class="summary-grid" id="summary">
        <div class="summary-item">
            <div class="label">ÙˆØ§Ø­Ø¯</div>
            <div class="value" id="smUnit">â€”</div>
        </div>
        <div class="summary-item">
            <div class="label">Ú©Ø§Ø±Ù…Ù†Ø¯</div>
            <div class="value" id="smEmployee">â€”</div>
        </div>
        <div class="summary-item">
            <div class="label">ØªØ¹Ø¯Ø§Ø¯ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</div>
            <div class="value" id="smCount">0</div>
        </div>
        <div class="summary-item">
            <div class="label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø±ØµØ¯</div>
            <div class="value" id="smAvg">0</div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  // ---- Endpoints ----
  const employeesApi = "{% url 'admin:reports_employees_api' %}";
  const dataApi = "{% url 'admin:reports_data_api' %}";

  // ---- DOM Refs ----
  const orgSelect = document.getElementById("orgSelect"); //Ø³Ø§Ø²Ù…Ø§Ù†
  console.log("ORG:", orgSelect);
  const unitSelect = document.getElementById("unitSelect");
  const unitSearch = document.getElementById("unitSearch");
  const employeeBox = document.getElementById("employeeBox");
  const employeeSelect = document.getElementById("employeeSelect");
  const employeeSearch = document.getElementById("employeeSearch");
  const yearSelect = document.getElementById("yearSelect");
  const btnDraw = document.getElementById("btnDraw");
  const btnCsv = document.getElementById("btnCsv");
  const btnPdf = document.getElementById("btnPdf");
  const btnPrintForm = document.getElementById("btnPrintForm");
  const statusEl = document.getElementById("status");
  const chartTitleEl = document.getElementById("chartTitle");
  const modeIndividualBtn = document.getElementById("modeIndividual");
  const modeUnitBtn = document.getElementById("modeUnit");
  const pieCanvasEl = document.getElementById("pieCanvas");
  const pieCard = pieCanvasEl ? pieCanvasEl.closest(".report-card") : null;

  let mode = "individual";
  let lineChart, pieChart;

  // âœ… Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ø³Ø§Ù„â€ŒÙ‡Ø§ (Ø§Ø² 2025 ØªØ§ 2020)
  function populateYears() {
    if (!yearSelect) return;
    const currentYear = new Date().getFullYear();
    yearSelect.innerHTML = '<option value="">All</option>';
    for (let y = currentYear; y >= 2020; y--) {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      yearSelect.appendChild(opt);
    }
  }
  document.addEventListener("DOMContentLoaded", populateYears);

  // ---------- Helpers ----------
  function filterOptions(input, select) {
    const q = (input?.value || "").toLowerCase().trim();
    [...(select?.options || [])].forEach((opt) => {
      const show = opt.text.toLowerCase().includes(q);
      opt.classList.toggle("hidden", !show);
    });
  }

  function setMode(newMode) {
    mode = newMode;
    if (mode === "unit") {
      modeUnitBtn?.classList.add("active");
      modeIndividualBtn?.classList.remove("active");
      if (employeeBox) employeeBox.style.display = "none";
    } else {
      modeIndividualBtn?.classList.add("active");
      modeUnitBtn?.classList.remove("active");
      if (employeeBox) employeeBox.style.display = "";
    }
  }

  function updateSummary(s) {
    (document.getElementById("smUnit") || {}).textContent = s?.unit || "â€”";
    (document.getElementById("smEmployee") || {}).textContent =
      s?.employee || "â€”";
    (document.getElementById("smCount") || {}).textContent = s?.count ?? 0;
    (document.getElementById("smAvg") || {}).textContent = (
      (s?.avg ?? 0)
    ).toFixed(2);
  }

  // ---------- Charts ----------
  function drawLine(c) {
    chartTitleEl.textContent = c?.title || "â€”";
    const ctx = document.getElementById("chartCanvas").getContext("2d");
    if (lineChart) lineChart.destroy();

    lineChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: c?.labels || [],
        datasets: (c?.datasets || []).map((ds) => ({
          label: ds.label,
          data: ds.data,
          backgroundColor: "#7c3aed99",
          borderColor: "#7c3aed",
          borderWidth: 1,
        })),
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                const val = ctx.parsed.y ?? 0;
                return `${ctx.dataset.label}: ${val.toFixed(2)}%`;
              },
            },
          },
          datalabels: {
            anchor: "end",
            align: "top",
            formatter: (value) => `${value.toFixed(1)}%`,
            color: "#4B5563",
            font: { weight: "bold" },
          },
        },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: "%" } },
        },
      },
      plugins: [ChartDataLabels],
    });
  }

  function drawPie(pie) {
    if (!pieCanvasEl) return;
    document.getElementById("pieTitle").textContent = pie?.title || "â€”";
    const ctx2 = pieCanvasEl.getContext("2d");
    if (pieChart) pieChart.destroy();

    const data = pie?.data || [];
    const total = data.reduce((a, b) => a + b, 0) || 1;
    pieChart = new Chart(ctx2, {
      type: "pie",
      data: {
        labels: pie?.labels || [],
        datasets: [
          {
            data,
            backgroundColor: [
              "#4B70DD",
              "#5DD39E",
              "#F4D35E",
              "#EE964B",
              "#F95738",
              "#B56576",
              "#6C757D",
            ],
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                const val = ctx.parsed;
                const pct = ((val / total) * 100).toFixed(1);
                return `${ctx.label}: ${val} (${pct}%)`;
              },
            },
          },
        },
      },
    });
  }

   window.addEventListener("resize", () => {
  clearTimeout(window._chartResizeTimer);
  window._chartResizeTimer = setTimeout(() => {
    if (lineChart) {
      lineChart.resize();
      lineChart.update();
    }
    if (pieChart) {
      pieChart.resize();
      pieChart.update();
    }
  }, 250);
});

  // ---------- Loaders ----------
  function loadEmployees(unitId) {
    if (!unitId || mode === "unit" || !employeeSelect)
      return Promise.resolve();
    statusEl.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ú©Ù†Ø§Ù†...";
    return fetch(`${employeesApi}?unit_id=${encodeURIComponent(unitId)}`)
      .then((r) => r.json())
      .then((data) => {
        employeeSelect.innerHTML = "";
        (data.results || []).forEach((item) => {
          const opt = document.createElement("option");
          opt.value = item.id;
          opt.textContent = item.text;
          employeeSelect.appendChild(opt);
        });
        statusEl.textContent = "";
      })
      .catch(() => {
        statusEl.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ú©Ù†Ø§Ù†";
      });
  }

  // ---------- Events ----------
  unitSearch?.addEventListener("input", () =>
    filterOptions(unitSearch, unitSelect)
  );
  employeeSearch?.addEventListener("input", () =>
    filterOptions(employeeSearch, employeeSelect)
  );

  // Load units when organization changes
orgSelect?.addEventListener("change", () => {
  const orgId = orgSelect.value;

  unitSelect.innerHTML = "";
  employeeSelect.innerHTML = "";

  if (!orgId) return;

  fetch("{% url 'admin:reports_load_units' %}?org_id=" + orgId)
    .then((r) => r.json())
    .then((data) => {
      (data.units || []).forEach((u) => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.name;
        unitSelect.appendChild(opt);
      });
    })
    .catch((err) => console.error("Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ ÙˆØ§Ø­Ø¯Ù‡Ø§:", err));
});


  modeIndividualBtn?.addEventListener("click", () => setMode("individual"));
  modeUnitBtn?.addEventListener("click", () => setMode("unit"));

  // preload units
<!--  fetch(window.location.pathname + "?format=units")-->
<!--    .then((r) => (r.ok ? r.json() : Promise.reject()))-->
<!--    .then((data) => {-->
<!--      (data.units || []).forEach((u) => {-->
<!--        const opt = document.createElement("option");-->
<!--        opt.value = u.id;-->
<!--        opt.textContent = u.name;-->
<!--        unitSelect?.appendChild(opt);-->
<!--      });-->
<!--    })-->
<!--    .catch(() => {});-->

  unitSelect?.addEventListener("change", async () => {
    const unitId = unitSelect.value;
    await loadEmployees(unitId);
    // Ø³Ø§Ù„â€ŒÙ‡Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ø¨Ø´Ù† Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ§Ø­Ø¯
    populateYears();
  });

  // ---------- Ajax Draw ----------
  btnDraw?.addEventListener("click", () => {
    const unitId = unitSelect?.value;
    if (!unitId) {
      statusEl.textContent = "ÙˆØ§Ø­Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.";
      return;
    }
    const params = new URLSearchParams({ mode, unit_id: unitId });
    const year = yearSelect?.value;
    const period = document.querySelector('input[name="period"]:checked')?.value;
    if (year) params.set("year", year);
    if (period) params.set("period", period);

    if (mode === "individual") {
      const empId = employeeSelect?.value;
      if (!empId) {
        statusEl.textContent = "Ú©Ø§Ø±Ù…Ù†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.";
        return;
      }
      params.set("employee_id", empId);
    }

    statusEl.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...";
    fetch(`${dataApi}?${params.toString()}`)
      .then((r) => (r.ok ? r.json() : Promise.reject(r.status)))
      .then((payload) => {
        statusEl.textContent = "";
        updateSummary(payload.summary || {});
        if (payload.chart) drawLine(payload.chart);
        if (pieCard) {
          if (payload.pie && Array.isArray(payload.pie.data) && payload.pie.data.length) {
            pieCard.style.display = "";
            drawPie(payload.pie);
          } else {
            pieCard.style.display = "none";
          }
        }
      })
      .catch((err) => {
        console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:", err);
        statusEl.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø± Console)";
      });
  });

  // ---------- CSV Export ----------
  if (btnCsv) {
    btnCsv.addEventListener("click", () => {
      const unitId = unitSelect?.value;
      if (!unitId) {
        alert("ÙˆØ§Ø­Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
        return;
      }
      const params = new URLSearchParams({ mode, unit_id: unitId });
      const year = yearSelect?.value;
      const period = document.querySelector('input[name="period"]:checked')?.value;
      if (year) params.set("year", year);
      if (period) params.set("period", period);
      if (mode === "individual") {
        const empId = employeeSelect?.value;
        if (!empId) {
          alert("Ú©Ø§Ø±Ù…Ù†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
          return;
        }
        params.set("employee_id", empId);
      }
      window.open(`/admin/core/evaluationreport/export/csv/?${params.toString()}`, "_blank");
    });
  }

  // ---------- Print Form ----------
  if (btnPrintForm) {
    btnPrintForm.addEventListener("click", () => {
      const empId = employeeSelect?.value;
      const unitId = unitSelect?.value;
      const year = yearSelect?.value;
      const period = document.querySelector('input[name="period"]:checked')?.value;

      if (!empId || !unitId) {
        alert("Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø­Ø¯ Ùˆ Ú©Ø§Ø±Ù…Ù†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
        return;
      }
      const params = new URLSearchParams({
        mode: "individual",
        unit_id: unitId,
        employee_id: empId,
      });
      if (year) params.set("year", year);
      if (period) params.set("period", period);

      // Ø¢Ø¯Ø±Ø³ Ù¾Ø±ÛŒÙ†Øª
      window.open("{% url 'admin:reports_print_form' %}?" + params.toString(), "_blank");
    });
  }

  // ---------- PDF Export ----------
  if (btnPdf) {
    btnPdf.addEventListener("click", () => {
      const unitId = unitSelect?.value;
      if (!unitId) {
        alert("ÙˆØ§Ø­Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
        return;
      }
      const params = new URLSearchParams({ mode, unit_id: unitId });
      const year = yearSelect?.value;
      const period = document.querySelector('input[name="period"]:checked')?.value;
      if (year) params.set("year", year);
      if (period) params.set("period", period);
      if (mode === "individual") {
        const empId = employeeSelect?.value;
        if (!empId) {
          alert("Ú©Ø§Ø±Ù…Ù†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
          return;
        }
        params.set("employee_id", empId);
      }
      window.open(`/admin/core/evaluationreport/export/pdf/?${params.toString()}`, "_blank");
    });
  }

  // Default mode
  setMode("individual");
});
</script>

{% endblock %}
